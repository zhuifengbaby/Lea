<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>arcgis 地图</title>
    <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/3.32/esri/css/esri.css" />
    <script src="https://js.arcgis.com/3.32/init.js"></script>
</head>

<body style="margin:0;">
    <div id="map" style="height: 100vh;"></div>


    <!-- javascript start -->
    <script>
        // doc: https://blog.csdn.net/chiguozhu9463/article/details/100853541
        var map;
        console.time()
        require([
            "esri/map",
            "dojo/domReady!"],
            function (Map) {
                function getToken(callback) {
                    const tokenServerUrl = "http://122.193.93.198:8080/RemoteTokenServer"
                    const username = 'fuqiao';  // 用户名
                    const password = 'fq123456';  // 密码
                    const clientid = 'ref.localhost';  // 有2种认证方式，referrer和ip，web页面适合使用referrer方式。生产环境中，需要把localhost替换为生产环境的域名
                    const expiration = 30; // token的有效时间，单位是分钟
                    // 使用jquery发送请求，获取token，存在跨域的问题，所以以jsonp方式发送请求
                    $.ajax({
                        url: tokenServerUrl,
                        jsonp: "callback",
                        dataType: "jsonp",
                        data: {
                            request: "getToken",
                            username: username,
                            password: password,
                            clientid: clientid,
                            expiration: expiration,
                            format: "json"
                        }
                    }).then(function (data) {
                        // 返回的数据中，data.token即为认证的token
                        // console.log(data);
                        console.timeEnd()
                        callback(data.token)
                    });
                }
                map = new Map("map", {
                    zoom: 13,
                    center: [121.1352, 31.5633],
                    logo: false
                });
                // 添加动态地图 ArcGISTiledMapServiceLayer
                // var geoqtiledUrl = "http://map.geoq.cn/arcgis/rest/services/ChinaOnlineStreetPurplishBlue/MapServer";
                // var geoqTiledLayer = new esri.layers.ArcGISTiledMapServiceLayer(geoqtiledUrl);
                // map.addLayer(geoqTiledLayer);
                function loadMapServer(token) {
                    var layerUrl = 'http://122.193.93.198:8080/OneMapServer/rest/services/tcyx_new/MapServer' + '?token=' + token;
                    var layer = new esri.layers.ArcGISTiledMapServiceLayer(layerUrl);
                    map.addLayer(layer);
                }
                getToken(loadMapServer);
                // web墨卡托(3857)转经纬度坐标(4326)
                map.on("click", function (event) {
                    var value = esri.geometry.webMercatorToGeographic(event.mapPoint);
                    // console.log(value)
                    console.log(event)
                })

                // 模拟高得地图 Marker
                function addMarker(opts) {
                    opts = opts || {};
                    var position = opts.position;
                    var wkid = opts.wkid || 4326;
                    var icon = opts.icon = opts.icon || "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png";
                    var iconSize = opts.iconSize = typeof opts.iconSize === "object" && opts.iconSize.length === 2 ? opts.iconSize : [19, 31];
                    // 绘图 graphic , 点 point , 图片标记符 PictureMarkerSymbol
                    var point = new esri.geometry.Point(position[0], position[1], new esri.SpatialReference({ wkid: wkid }));
                    var image = new esri.symbol.PictureMarkerSymbol(icon, iconSize[0], iconSize[1]);
                    // image.setOffset(0, 27.5);//y轴方向向上偏移27.5个像素
                    var graphic = new esri.Graphic(point, image);
                    // 扩展一个 extData 字段
                    graphic.extData = opts.extData || {};
                    return graphic
                }

                var msarkers = [];
                // 在地图加载完毕后开始画图层上面的数据
                map.on("load", function () {
                    // 绘图 graphic
                    var marker = addMarker({
                        position: [120.543, 30.256]
                    })
                    map.graphics.add(marker);
                    console.log(marker)
                    // 设置地图中心
                    // map.setZoom(15);
                    // map.centerAt(marker.geometry);
                    map.centerAndZoom(marker.geometry,15)
                    // 删除绘图
                    // map.graphics.remove(marker);
                    map.graphics.on("click", function (e) {
                        var data = e.graphic.extData;
                        console.log(data)
                    })
                });
            });
    </script>
</body>

</html>